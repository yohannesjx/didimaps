<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Didi Maps - Addis Ababa</title>
  <script src="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }

    /* Hide MapLibre logo and attribution for a cleaner UI (keep attribution elsewhere if needed) */
    .maplibregl-ctrl-logo,
    .maplibregl-ctrl-attrib,
    .maplibregl-ctrl-attrib-inner {
      display: none !important;
    }
    
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      width: 320px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .controls.collapsed {
      width: auto;
    }

    .controls.collapsed .controls-body {
      display: none;
    }

    .controls-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      cursor: pointer;
      user-select: none;
    }

    .controls-header:hover {
      background: #f5f5f5;
    }
    
    .controls h2 {
      font-size: 18px;
      margin: 0;
      color: #333;
    }

    .collapse-btn {
      background: none;
      border: none;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      color: #666;
      transition: transform 0.3s ease;
    }

    .controls.collapsed .collapse-btn {
      transform: rotate(180deg);
    }

    .controls-body {
      padding: 0 15px 15px;
    }
    
    .search-box {
      position: relative;
      margin-bottom: 10px;
    }
    
    .search-box input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .search-box input:focus {
      outline: none;
      border-color: #4A90D9;
    }
    
    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 1px solid #ddd;
      border-top: none;
      border-radius: 0 0 6px 6px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
      z-index: 1001;
    }
    
    .search-results.active { display: block; }
    
    .search-result-item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
      font-size: 13px;
    }
    
    .search-result-item:hover { background: #f5f5f5; }
    .search-result-item:last-child { border-bottom: none; }
    
    .route-inputs {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .route-inputs input {
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .btn {
      width: 100%;
      padding: 10px;
      background: #4A90D9;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 8px;
    }
    
    .btn:hover { background: #3A7BC8; }
    .btn.secondary { background: #6c757d; }
    .btn.secondary:hover { background: #5a6268; }
    
    .route-info {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
      font-size: 13px;
      display: none;
    }
    
    .route-info.active { display: block; }
    
    .route-info p { margin: 4px 0; }
    .route-info strong { color: #333; }
    
    .status {
      font-size: 12px;
      color: #666;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }
    
    .status.error { color: #dc3545; }
    .status.success { color: #28a745; }

    .instructions {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <div class="controls" id="controls">
    <div class="controls-header" id="controlsHeader">
      <h2>ðŸš— Didi Maps</h2>
      <button class="collapse-btn" id="collapseBtn">â–¼</button>
    </div>
    
    <div class="controls-body">
      <!-- Search -->
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search location in Addis..." />
        <div class="search-results" id="searchResults"></div>
      </div>
      
      <!-- Routing -->
      <div class="route-inputs">
        <input type="text" id="fromInput" placeholder="From (click map or search)" readonly />
        <input type="text" id="toInput" placeholder="To (click map or search)" readonly />
      </div>
      
      <button class="btn" id="routeBtn">Get Route</button>
      <button class="btn secondary" id="clearBtn">Clear</button>
      
      <div class="route-info" id="routeInfo">
        <p><strong>Distance:</strong> <span id="distance">-</span></p>
        <p><strong>Duration:</strong> <span id="duration">-</span></p>
      </div>

      <p class="instructions">
        ðŸ’¡ Click on the map to set From/To points, or search for locations.
      </p>
      
      <div class="status" id="status">Connecting...</div>
    </div>
  </div>

  <script>
    // ============ CONFIG ============
    const API_BASE = 'https://maps.didi.et';
    const TILE_URL = 'https://maps.didi.et/tiles/services/addis/tiles/{z}/{x}/{y}.pbf';

    // Addis Ababa center
    const ADDIS_CENTER = [38.7578, 9.0054];
    const DEFAULT_ZOOM = 12;

    // ============ STATE ============
    let token = null;
    let fromCoords = null;
    let toCoords = null;
    let clickMode = 'from'; // 'from' or 'to'
    let markers = { from: null, to: null };

    // ============ MAP SETUP ============
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        name: 'Addis Ababa - Light BW',
        glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf',
        sources: {
          'osm-tiles': {
            type: 'vector',
            tiles: [TILE_URL],
            maxzoom: 14
          }
        },
        layers: [
          // Background (pure white)
          {
            id: 'background',
            type: 'background',
            paint: { 'background-color': '#ffffff' }
          },
          // Water (strong blue)
          {
            id: 'water',
            type: 'fill',
            source: 'osm-tiles',
            'source-layer': 'water',
            paint: { 'fill-color': '#a6c8ff' }
          },
          // Landuse (very subtle light grey)
          {
            id: 'landuse-residential',
            type: 'fill',
            source: 'osm-tiles',
            'source-layer': 'landuse',
            filter: ['==', 'class', 'residential'],
            paint: { 'fill-color': '#f2f2f2' }
          },
          {
            id: 'landuse-park',
            type: 'fill',
            source: 'osm-tiles',
            'source-layer': 'landuse',
            filter: ['in', 'class', 'park', 'grass'],
            paint: { 'fill-color': '#eef6ee' }
          },
          // Buildings
          {
            id: 'buildings',
            type: 'fill',
            source: 'osm-tiles',
            'source-layer': 'building',
            paint: {
              'fill-color': '#e3e3e3',
              'fill-outline-color': '#cfcfcf',
              'fill-opacity': 0.9
            }
          },
          // Minor roads (light grey)
          {
            id: 'roads-minor',
            type: 'line',
            source: 'osm-tiles',
            'source-layer': 'transportation',
            filter: ['in', 'class', 'minor', 'service', 'residential'],
            paint: {
              'line-color': '#e0e0e0',
              'line-width': 1.2,
              'line-opacity': 1
            }
          },
          // Secondary roads (dark grey)
          {
            id: 'roads-secondary',
            type: 'line',
            source: 'osm-tiles',
            'source-layer': 'transportation',
            filter: ['==', 'class', 'secondary'],
            paint: {
              'line-color': '#b3b3b3',
              'line-width': 2.2,
              'line-opacity': 1
            }
          },
          // Primary roads (almost black)
          {
            id: 'roads-primary',
            type: 'line',
            source: 'osm-tiles',
            'source-layer': 'transportation',
            filter: ['==', 'class', 'primary'],
            paint: {
              'line-color': '#4a4a4a',
              'line-width': 3,
              'line-opacity': 1
            }
          },
          // Trunk/motorway (pure black)
          {
            id: 'roads-trunk',
            type: 'line',
            source: 'osm-tiles',
            'source-layer': 'transportation',
            filter: ['in', 'class', 'trunk', 'motorway'],
            paint: {
              'line-color': '#000000',
              'line-width': 3.5,
              'line-opacity': 1
            }
          },
          // Road casing to give depth on trunk/motorway
          {
            id: 'roads-trunk-casing',
            type: 'line',
            source: 'osm-tiles',
            'source-layer': 'transportation',
            filter: ['in', 'class', 'trunk', 'motorway'],
            paint: {
              'line-color': '#c0c0c0',
              'line-width': 5,
              'line-opacity': 0.7
            }
          },
          // Road labels
          {
            id: 'road-labels',
            type: 'symbol',
            source: 'osm-tiles',
            'source-layer': 'transportation_name',
            layout: {
              'text-field': '{name}',
              'text-size': 11,
              'symbol-placement': 'line'
            },
            paint: {
              'text-color': '#7a7a7a',
              'text-halo-color': '#ffffff',
              'text-halo-width': 1.5
            }
          },
          // Place labels
          {
            id: 'place-labels',
            type: 'symbol',
            source: 'osm-tiles',
            'source-layer': 'place',
            layout: {
              'text-field': '{name}',
              'text-size': ['interpolate', ['linear'], ['zoom'], 10, 12, 14, 16]
            },
            paint: {
              'text-color': '#222222',
              'text-halo-color': '#ffffff',
              'text-halo-width': 2
            }
          },
          // POI labels
          {
            id: 'poi-labels',
            type: 'symbol',
            source: 'osm-tiles',
            'source-layer': 'poi',
            minzoom: 14,
            layout: {
              'text-field': '{name}',
              'text-size': 11
            },
            paint: {
              'text-color': '#555555',
              'text-halo-color': '#ffffff',
              'text-halo-width': 1.5
            }
          }
        ]
      },
      center: ADDIS_CENTER,
      zoom: DEFAULT_ZOOM
    });

    // Add navigation controls
    map.addControl(new maplibregl.NavigationControl(), 'bottom-right');

    // ============ AUTH ============
    async function login() {
      try {
        const res = await fetch(`${API_BASE}/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: 'user@example.com', password: 'pass' })
        });
        const data = await res.json();
        if (data.access_token) {
          token = data.access_token;
          setStatus('Connected âœ“', 'success');
          return true;
        }
      } catch (e) {
        setStatus('API connection failed', 'error');
      }
      return false;
    }

    // ============ SEARCH ============
    let searchTimeout = null;
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');

    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      const q = e.target.value.trim();
      if (q.length < 2) {
        searchResults.classList.remove('active');
        return;
      }
      searchTimeout = setTimeout(() => search(q), 300);
    });

    async function search(query) {
      if (!token) return;
      try {
        const res = await fetch(`${API_BASE}/api/search?q=${encodeURIComponent(query)}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        displaySearchResults(data.results || []);
      } catch (e) {
        console.error('Search error:', e);
      }
    }

    function displaySearchResults(results) {
      if (!results.length) {
        searchResults.classList.remove('active');
        return;
      }
      searchResults.innerHTML = results.slice(0, 5).map(r => `
        <div class="search-result-item" data-lat="${r.lat}" data-lng="${r.lng}" data-name="${r.display_name}">
          ${r.display_name.substring(0, 60)}${r.display_name.length > 60 ? '...' : ''}
        </div>
      `).join('');
      searchResults.classList.add('active');
    }

    searchResults.addEventListener('click', (e) => {
      const item = e.target.closest('.search-result-item');
      if (!item) return;
      const lat = parseFloat(item.dataset.lat);
      const lng = parseFloat(item.dataset.lng);
      const name = item.dataset.name;
      
      map.flyTo({ center: [lng, lat], zoom: 15 });
      setPoint(lng, lat, name);
      
      searchInput.value = '';
      searchResults.classList.remove('active');
    });

    // Close search results when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.search-box')) {
        searchResults.classList.remove('active');
      }
    });

    // ============ MAP CLICK ============
    map.on('click', (e) => {
      const { lng, lat } = e.lngLat;
      reverseGeocode(lng, lat);
    });

    async function reverseGeocode(lng, lat) {
      if (!token) return;
      try {
        const res = await fetch(`${API_BASE}/api/reverse?lat=${lat}&lng=${lng}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        const name = data.display_name || `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        setPoint(lng, lat, name);
      } catch (e) {
        setPoint(lng, lat, `${lat.toFixed(5)}, ${lng.toFixed(5)}`);
      }
    }

    function setPoint(lng, lat, name) {
      if (clickMode === 'from') {
        fromCoords = [lng, lat];
        document.getElementById('fromInput').value = name.substring(0, 40);
        setMarker('from', lng, lat, '#4A90D9');
        clickMode = 'to';
      } else {
        toCoords = [lng, lat];
        document.getElementById('toInput').value = name.substring(0, 40);
        setMarker('to', lng, lat, '#28a745');
        clickMode = 'from';
      }
    }

    function setMarker(type, lng, lat, color) {
      if (markers[type]) markers[type].remove();
      
      const el = document.createElement('div');
      el.style.cssText = `
        width: 24px; height: 24px; background: ${color}; border-radius: 50%;
        border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      `;
      
      markers[type] = new maplibregl.Marker({ element: el })
        .setLngLat([lng, lat])
        .addTo(map);
    }

    // ============ ROUTING ============
    document.getElementById('routeBtn').addEventListener('click', getRoute);

    async function getRoute() {
      if (!fromCoords || !toCoords) {
        setStatus('Set both From and To points', 'error');
        return;
      }
      if (!token) {
        setStatus('Not authenticated', 'error');
        return;
      }

      setStatus('Calculating route...', '');

      try {
        const res = await fetch(
          `${API_BASE}/api/route?from=${fromCoords[1]},${fromCoords[0]}&to=${toCoords[1]},${toCoords[0]}`,
          { headers: { 'Authorization': `Bearer ${token}` } }
        );
        const data = await res.json();

        if (data.code === 'Ok' && data.routes && data.routes.length > 0) {
          const route = data.routes[0];
          displayRoute(route);
          setStatus('Route found âœ“', 'success');
        } else {
          setStatus('No route found', 'error');
        }
      } catch (e) {
        console.error('Route error:', e);
        setStatus('Routing failed', 'error');
      }
    }

    function displayRoute(route) {
      // Decode polyline
      const coords = decodePolyline(route.geometry);
      
      // Remove existing route layer
      if (map.getSource('route')) {
        map.removeLayer('route-line');
        map.removeSource('route');
      }

      // Add route to map
      map.addSource('route', {
        type: 'geojson',
        data: {
          type: 'Feature',
          geometry: { type: 'LineString', coordinates: coords }
        }
      });

      map.addLayer({
        id: 'route-line',
        type: 'line',
        source: 'route',
        paint: {
          'line-color': '#4A90D9',
          'line-width': 5,
          'line-opacity': 0.8
        }
      });

      // Fit bounds
      const bounds = coords.reduce((b, c) => b.extend(c), new maplibregl.LngLatBounds(coords[0], coords[0]));
      map.fitBounds(bounds, { padding: 80 });

      // Show route info
      const distance = (route.distance / 1000).toFixed(1);
      const duration = Math.round(route.duration / 60);
      document.getElementById('distance').textContent = `${distance} km`;
      document.getElementById('duration').textContent = `${duration} min`;
      document.getElementById('routeInfo').classList.add('active');
    }

    // Decode Google-style polyline
    function decodePolyline(encoded) {
      const coords = [];
      let index = 0, lat = 0, lng = 0;
      while (index < encoded.length) {
        let b, shift = 0, result = 0;
        do {
          b = encoded.charCodeAt(index++) - 63;
          result |= (b & 0x1f) << shift;
          shift += 5;
        } while (b >= 0x20);
        lat += (result & 1) ? ~(result >> 1) : (result >> 1);

        shift = 0; result = 0;
        do {
          b = encoded.charCodeAt(index++) - 63;
          result |= (b & 0x1f) << shift;
          shift += 5;
        } while (b >= 0x20);
        lng += (result & 1) ? ~(result >> 1) : (result >> 1);

        coords.push([lng / 1e5, lat / 1e5]);
      }
      return coords;
    }

    // ============ CLEAR ============
    document.getElementById('clearBtn').addEventListener('click', () => {
      fromCoords = null;
      toCoords = null;
      clickMode = 'from';
      document.getElementById('fromInput').value = '';
      document.getElementById('toInput').value = '';
      document.getElementById('routeInfo').classList.remove('active');
      
      if (markers.from) markers.from.remove();
      if (markers.to) markers.to.remove();
      markers = { from: null, to: null };
      
      if (map.getSource('route')) {
        map.removeLayer('route-line');
        map.removeSource('route');
      }
      
      setStatus('Cleared', 'success');
    });

    // ============ STATUS ============
    function setStatus(msg, type) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = 'status' + (type ? ' ' + type : '');
    }

    // ============ COLLAPSE ============
    document.getElementById('controlsHeader').addEventListener('click', () => {
      document.getElementById('controls').classList.toggle('collapsed');
    });

    // ============ INIT ============
    map.on('load', async () => {
      await login();
    });
  </script>
</body>
</html>
